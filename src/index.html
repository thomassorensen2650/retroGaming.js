<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Emulator</title>
    <script src="Mapper_000.js" type="text/javascript"></script>
    <script src="CPU.js" type="text/javascript"></script>
    <script src="bus.js" type="text/javascript"></script>
    <script src="ppu.js" type="text/javascript"></script>
    <script src="Cartridge.js" type="text/javascript"></script>

    <link rel="stylesheet" href="style.css">
    <script>
    window.toHex = function(number, size) {
            let hex = number.toString(16).toUpperCase();
            while (hex.length < size) {
                hex = "0" + hex;
            }
            return "0x" + hex;
    ;}
    window.toBin = function(number) {
        let bin = number.toString(2);
        while (bin.length < 8) {
            bin = "0" + bin;
        }
        return bin;
    }

    let addRow = function(op) {
            if (op.address === toHex(cpu.pc)){
                return `<tr class="highlight"><td>${op.address}</td><td>${op.op}</td><td>${op.addrMode}</td></tr>`;
            } else {
                return `<tr><td>${op.address}</td><td>${op.op}</td><td>${op.addrMode}</td></tr>`
            }
    };

    var cartridge = window.Cartridge;

    let ppu = window.PPU;
    let cpu = window.CPU;//new window.CPU(bus);
    let bus = new window.Bus(cartridge, cpu, ppu);

    step = function() {
        do {
            
            bus.clock();
        }
        while (cpu._cycles > 0)
        
    };
    loadRom = function() {
        console.log("Loading ROM");
        bus.loadCartridge(document.querySelector('input[type=file]').files[0]);
        //window.asm = cpu.disassemble(0x0000, 0xFFFF);
    };

        cpu.connectBus(bus);
        cpu.propertyListener = function(property,value) {
            switch(property) {
                case "a":
                    document.getElementById("reg_a_h").innerHTML = toHex(cpu.a, 2);
                    document.getElementById("reg_a_b").innerHTML = toBin(cpu.a);
                    break;
                case "x":
                    document.getElementById("reg_x_h").innerHTML = toHex(cpu.x, 2);
                    document.getElementById("reg_x_b").innerHTML = toBin(cpu.x);
                    break;
                case "y":
                    document.getElementById("reg_y_h").innerHTML = toHex(cpu.y, 2);
                    document.getElementById("reg_y_b").innerHTML = toBin(cpu.y);
                    break;
                case "stkp":
                    document.getElementById("stkp_h").innerHTML = toHex(cpu.stkp, 4);
                    document.getElementById("stkp_b").innerHTML = toBin(cpu.stkp);
                    break;
                case "status":
                    document.getElementById("status_h").innerHTML = toHex(cpu.status, 2);
                    document.getElementById("status_b").innerHTML = toBin(cpu.status);
                    break;
                case "pc":
                    document.getElementById("pc_h").innerHTML = toHex(cpu.pc, 4);
                    document.getElementById("pc_b").innerHTML = toBin(cpu.pc);

                    /* FIXME : This performance is bad, only for testing.
                    if (window.asm === undefined) {
                        window.asm = cpu.disassemble(0x0000, 0xFFFF);
                    } */

                    // window.asm.slice(cpu.pc-1, cpu.pc+9)
                    document.getElementById("disassembleTableBody").innerHTML = cpu.disassemble(cpu.pc, cpu.pc+10)
                .map(x => addRow(x)).join('');

                    break;
                default:
                    console.log("Unknown Property " + property)
            }
        }
   
    </script>
</head>
<body>
    <div id="debugWindow">
        <h1>Registers</h1>
        <div id="variables">
            <table id="registerTable">
                <thead><tr><td></td><td></td></tr></thead>
                <tbody>
                    <tr>
                        <td>A</td>
                        <td id="reg_a_h">0x2200</td>
                        <td id="reg_a_b">0x2200</td>
                    </tr>
                    <tr>
                        <td>X</td>
                        <td id="reg_x_h">0x2200</td>
                        <td id="reg_x_b">0x2200</td>
                    </tr>
                    <tr>
                        <td>Y</td>
                        <td id="reg_y_h">0x2200</td>
                        <td id="reg_y_b">0x2200</td>
                    </tr>
                    <tr>
                        <td>StackPtr</td>
                        <td id="stkp_h">0x2200</td>
                        <td id="stkp_b">0x2200</td>
                    </tr>
                    <tr>
                        <td>Status</td>
                        <td id="status_h">0x2200</td>
                        <td id="status_b">0x2200</td>
                    </tr>
                    <tr>
                        <td>Prog cnt.</td>
                        <td id="pc_h">0x2200</td>
                        <td id="pc_b">0x2200</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <h1>disassembler</h1>
        <div id="commands">
            <button class="cmdButton" onclick="step()">Step</button>
           <button class="cmdButton" onclick="bus.drawPatternTable(document.getElementById('spriteCanvas'));">Goto PC</button>
        </div>
        <div id="disassemble">
            <table id="disassembleTable">
                <thead><tr><td></td><td></td><td></td><td></td></tr></thead>
                <tbody id="disassembleTableBody"></tbody>
                </table>
        </div>
        <h1>NES Commands</h1>
        <div id="commands">
            <button class="cmdButton" onclick="cpu.reset()">Reset</button>
            <button class="cmdButton" onclick="document.getElementById('loadRom').click()">Load Game</button>  
            <input type="file" id="loadRom" style="display:none" onchange="loadRom()"/>
        </div>
        <canvas id="spriteCanvas" style="border: 1px solid red;" height="255px" width="255px" />
    </div>
    <canvas id="gameCanvas" />
</body>
</html>